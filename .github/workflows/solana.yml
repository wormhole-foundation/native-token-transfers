name: Solana CI
on:
  workflow_dispatch:
  pull_request:
    paths:
      - "solana/**"
      - ".github/workflows/solana.yml"
      - ".github/actions/setup-anchor/**"
  push:
    branches:
      - main
      - dev
    paths:
      - "solana/**"
      - ".github/workflows/solana.yml"
      - ".github/actions/setup-anchor/**"

# Cancel in-progress runs on new commits to same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    working-directory: ./solana

jobs:
  # Linting runs on standard ubuntu runner (no need for tilt-kube-public)
  lint:
    name: Solana Lint
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: -Dwarnings
    steps:
      - uses: actions/checkout@v5

      - name: Get rust toolchain version
        id: toolchain
        run: |
          RUST_VERSION="$(awk '/channel =/ { print substr($3, 2, length($3)-2) }' rust-toolchain)"
          echo "version=${RUST_VERSION}" >> $GITHUB_OUTPUT

      - name: Install rust toolchain
        uses: dtolnay/rust-toolchain@55c7845fad90d0ae8b2e83715cb900e5e861e8cb
        with:
          toolchain: ${{ steps.toolchain.outputs.version }}
          components: "clippy,rustfmt"

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "solana"

      - name: Run `cargo fmt`
        run: cargo fmt --check --all --manifest-path Cargo.toml

      - name: Run `cargo check`
        run: cargo check --workspace --tests --manifest-path Cargo.toml --features mainnet

      - name: Run `cargo clippy`
        run: cargo clippy --workspace --tests --manifest-path Cargo.toml --features mainnet -- -Dclippy::cast_possible_truncation

  # SBF build and tests require Solana tools
  # Note: This doesn't need tilt-kube-public - standard ubuntu runner works fine
  solana-sbf:
    name: Solana Cargo SBF
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: -Dwarnings
    steps:
      - uses: actions/checkout@v5

      - name: Get rust toolchain version
        id: toolchain
        run: |
          RUST_VERSION="$(awk '/channel =/ { print substr($3, 2, length($3)-2) }' rust-toolchain)"
          echo "version=${RUST_VERSION}" >> $GITHUB_OUTPUT

      - name: Get solana version
        id: solana
        run: |
          SOLANA_VERSION="$(awk '/solana-program =/ { print substr($3, 3, length($3)-3) }' Cargo.toml)"
          echo "version=${SOLANA_VERSION}" >> $GITHUB_OUTPUT

      - name: Install rust toolchain
        uses: dtolnay/rust-toolchain@55c7845fad90d0ae8b2e83715cb900e5e861e8cb
        with:
          toolchain: ${{ steps.toolchain.outputs.version }}

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "solana"

      - name: Cache solana tools
        id: cache-solana
        uses: actions/cache@v4
        env:
          cache-name: solana-tools
        with:
          path: |
            ~/.local/share/solana/install/
            ~/.cache/solana/
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ steps.solana.outputs.version }}

      - if: ${{ steps.cache-solana.outputs.cache-hit != 'true' }}
        name: Install solana tools
        env:
          SOLANA_VERSION: ${{ steps.solana.outputs.version }}
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/v${SOLANA_VERSION}/install)"
          ~/.local/share/solana/install/active_release/bin/sdk/sbf/scripts/install.sh

      - name: Build SBF programs
        env:
          RUST_BACKTRACE: "1"
        run: |
          export BPF_OUT_DIR="$(pwd)/target/deploy"
          export PATH="${HOME}/.local/share/solana/install/active_release/bin:${PATH}"
          mkdir -p "${BPF_OUT_DIR}"
          cargo build-sbf --features "mainnet"

      - name: Run tests in parallel
        env:
          RUST_BACKTRACE: "1"
        run: |
          export BPF_OUT_DIR="$(pwd)/target/deploy"
          export PATH="${HOME}/.local/share/solana/install/active_release/bin:${PATH}"

          # Run test-sbf for both packages in parallel, plus native tests
          cargo test-sbf -p "example-native-token-transfers" --features "mainnet" &
          pid1=$!
          cargo test-sbf -p "ntt-transceiver" --features "mainnet,testing" &
          pid2=$!
          cargo test --features "mainnet" &
          pid3=$!

          # Wait for all and capture exit codes
          wait $pid1 || exit 1
          wait $pid2 || exit 1
          wait $pid3 || exit 1

      - name: Upload SBF artifacts
        uses: actions/upload-artifact@v4
        with:
          name: solana-sbf-programs
          path: solana/target/deploy/*.so
          retention-days: 1

  check-version:
    name: Check version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - run: ./scripts/sync-versions --check
        shell: bash

  anchor-test:
    name: Anchor Test
    needs: solana-sbf
    runs-on: ubuntu-latest
    env:
      node-version: "24"
      solana-cli-version: "1.18.26"
      anchor-version: "0.29.0"
    steps:
      - uses: actions/checkout@v5

      - uses: ./.github/actions/setup-anchor
        with:
          anchor-version: ${{ env.anchor-version }}
          solana-cli-version: ${{ env.solana-cli-version }}
          node-version: ${{ env.node-version }}

      - name: Download SBF artifacts
        uses: actions/download-artifact@v4
        with:
          name: solana-sbf-programs
          path: solana/target/deploy

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ./solana/node_modules/
          key: node-modules-${{ runner.os }}-build-${{ env.node-version }}

      - name: Install node_modules
        run: make node_modules
        shell: bash

      - name: Create keypair
        run: solana-keygen new --no-bip39-passphrase
        shell: bash

      - name: Make Anchor.toml compatible with runner
        run: sed -i 's:/user/:/runner/:' Anchor.toml
        shell: bash

      - name: Build TypeScript SDK
        run: |
          cd .. && npm ci && npm run build:solana
        shell: bash

      - name: Run anchor lint
        run: make anchor-lint
        shell: bash

      - name: Run tests
        run: anchor test --skip-build
        shell: bash
